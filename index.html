<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>GOOGLE FLIGHTS</title>
    <style>

      #map {
        height: 700px;  /* The height is 400 pixels */
        width: 100%;  /* The width is the width of the web page */
       }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The key parameter will contain your own API key (which is not needed for this tutorial)
    * The callback parameter executes the initMap() function
    -->


    <script src="./node_modules/socket.io/node_modules/socket.io-client/dist/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>

      var map;
      function initMap() {
        // Information of Location
        var location = {lat:42.3601, lng: -71.0589}
        var options = {
          zoom:2,
          center: location
        }

        // The map centered at Location
        map = new google.maps.Map(
            document.getElementById('map'), options);
      }

      function changeMarkerPosition(marker, position, angle) {
        var latlng = new google.maps.LatLng(position[0], position[1]);
        marker.setPosition(latlng);
        if (angle > 360){
          angle = angle - 360
        }
        var planeIcon = {
            url: "https://cdn1.iconfinder.com/data/icons/ios-11-glyphs/30/airplane_mode_on-256.png", // url
            scaledSize: new google.maps.Size(50, 50), // scaled size
            origin: new google.maps.Point(0,0), // origin
            anchor: new google.maps.Point(25, 25), // anchor
            rotation: angle
        };
        console.log('DEGREE ' + angle)
        marker.setIcon(planeIcon);
      };

      function addAirport(props, map){
        var marker = new google.maps.Marker({
          position:props.coords,
          map:map,
        });

        // Check content
        if (props.content){
          var infoWindow = new google.maps.InfoWindow({
            content:props.content
          });
          marker.addListener('mouseover', function(){
            infoWindow.open(map, marker);
          });
          marker.addListener('mouseout', function() {
            infoWindow.close();
          });
        }

      }

      function addPlane(props, map){
        var planeIcon = {
            url: "https://cdn1.iconfinder.com/data/icons/ios-11-glyphs/30/airplane_mode_on-256.png", // url
            scaledSize: new google.maps.Size(50, 50), // scaled size
            origin: new google.maps.Point(0,0), // origin
            anchor: new google.maps.Point(25, 25) // anchor
        };
        var marker = new google.maps.Marker({
          position:props.coords,
          map:map,
          icon: planeIcon
        });


        // Check content
        if (props.content){
          var infoWindow = new google.maps.InfoWindow({
            content:props.content
          });
          marker.addListener('mouseover', function(){
            infoWindow.open(map, marker);
          });
          marker.addListener('mouseout', function() {
            infoWindow.close();
          });
        };
        return marker;


      }

      // Iniciando conexion al socket
      var socket = io.connect('wss://integracion-tarea-3.herokuapp.com', {
        "path": "/flights"
      });

      socket.emit('AIRPORTS', {'a':''});
      socket.on('AIRPORTS', function(msg){
        console.log('Airport: ' + msg);
        var keys = Object.keys(msg);
        for (var i = 0; i < keys.length; i++){
          var airport = msg[keys[i]];
          marker_data = {
            coords: {lat:airport.airport_position[0], lng: airport.airport_position[1]},
            content:'<h2>'+ airport.name + ' ('+ airport.airport_code +')' +'</h2>\n<h3>'+ airport.city +', ' + airport.country + ' ('+ airport.country_code +')' +'</h3>'
          };
          addAirport(marker_data, map);
        };
      });

      var aviones = {};
      socket.emit('FLIGHTS', {'a':''});
      socket.on('FLIGHTS', function(vuelos){
        console.log('Flight: ' + vuelos[0].airline);
        for (var i = 0; i < vuelos.length; i++){
          var vuelo = vuelos[i];
          var origin = vuelo.origin;
          var destination = vuelo.destination;
          var line_data = [
            {lat: destination.airport_position[0], lng: destination.airport_position[1]},
            {lat: origin.airport_position[0], lng: origin.airport_position[1]}
          ];
          var flightPath = new google.maps.Polyline({
            path: line_data,
            geodesic: true,
            strokeColor: '#000000',
            strokeOpacity: 1.0,
            strokeWeight: 5
          });
          flightPath.setMap(map);

          aviones[vuelo.code] = vuelo;
          console.log('PLANE ' + aviones)

        };
      });

      // Recibo la informacion del socket al hacer socket.on POSITION
      var markers = {};
      var current_position = {};
      socket.on('POSITION', function(data){
        console.log('Avion: '+ data.code +' Posicion: ' + data.position);
        /*marker_data = {
          coords: {lat:data.position[0], lng: data.position[1]},
          iconImage:'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
          content:'<h1>'+ data.code +'</h1>'
        };*/
        if (markers[data.code]){
          var angleDeg = Math.atan2(current_position[data.code][1] - data.position[1], current_position[data.code][0] - data.position[0]) * 180 / Math.PI;
          console.log(angleDeg);
          let angle = Math.PI + Math.atan2(current_position[data.code][0] - data.position[0], current_position[data.code][1] - data.position[1]);
          console.log(angle * 180 / Math.PI);
          changeMarkerPosition(markers[data.code], data.position, angle * 180 / Math.PI + 90);
          var line_data = [
            {lat: current_position[data.code][0], lng: current_position[data.code][1]},
            {lat: data.position[0], lng: data.position[1]}
          ];


          var flightPath = new google.maps.Polyline({
            path: line_data,
            geodesic: true,
            strokeColor: '#FE642E',
            strokeOpacity: 1.0,
            strokeWeight: 8
          });
          flightPath.setMap(map);
          current_position[data.code] = data.position;
        }
        else{
          current_position[data.code] = data.position;
          var plane_data = aviones[data.code];
          var information = {
            coords: {lat:data.position[0], lng: data.position[1]},
            content:'<h2>Vuelo '+ data.code + ' ('+ plane_data.airline +')' +'</h2>\n<h3>Salida: '+ plane_data.origin.name +'</h3>\n<h3>Llegada: '+ plane_data.destination.name +'</h3>\n<h3>Asientos: '+ plane_data.seats+'</h3>'
          };
          markers[data.code] = addPlane(information, map);
        }
      });

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBW9yZgKJUsNAQChayGv6s1K1S7Lf2-Erc&callback=initMap">
    </script>
  </body>
</html>
