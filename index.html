<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>GOOGLE FLIGHTS</title>
    <style>

      #map {
        height: 550px;  /* The height is 400 pixels */
        width: 100%;  /* The width is the width of the web page */
       }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The key parameter will contain your own API key (which is not needed for this tutorial)
    * The callback parameter executes the initMap() function
    -->


    <script src="./node_modules/socket.io/node_modules/socket.io-client/dist/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>

    var map;
    function initMap() {
      // Information of Location
      var location = {lat:42.3601, lng: -71.0589}
      var options = {
        zoom:2,
        center: location
      }

      // The map centered at Location
      map = new google.maps.Map(
          document.getElementById('map'), options);

      /*
      // The marker, positioned at Uluru
      var marker = new google.maps.Marker({
        position: location,
        map: map,
        icon: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png'
      });

      var infoWindow = new google.maps.infoWindow({
        content:'<h1>Lynn Ma</h1>'
      });

      marker.addListener('click', function(){
        infoWindow.open(map, marker);
      });
      */

    }

    function addAirport(props, map){
      var marker = new google.maps.Marker({
        position:props.coords,
        map:map,
      });

      // Check content
      if (props.content){
        var infoWindow = new google.maps.InfoWindow({
          content:props.content
        });
        marker.addListener('mouseover', function(){
          infoWindow.open(map, marker);
        });
        marker.addListener('mouseout', function() {
          infoWindow.close();
        });
      }

    }

      // Iniciando conexion al socket
      var socket = io.connect('wss://integracion-tarea-3.herokuapp.com', {
        "path": "/flights"
      });

      socket.emit('AIRPORTS', {'a':''});
      socket.on('AIRPORTS', function(msg){
        console.log('Airport: ' + msg);
        var keys = Object.keys(msg);
        for (var i = 0; i < keys.length; i++){
          var airport = msg[keys[i]];
          marker_data = {
            coords: {lat:airport.airport_position[0], lng: airport.airport_position[1]},
            iconImage:'plane/blue_plane.png',
            content:'<h2>'+ airport.name + ' ('+ airport.airport_code +')' +'</h2>\n<h3>'+ airport.city +', ' + airport.country + ' ('+ airport.country_code +')' +'</h3>'
          };
          addAirport(marker_data, map);
        };
      });

      socket.emit('FLIGHTS', {'a':''});
      socket.on('FLIGHTS', function(vuelos){
        console.log('Flight: ' + vuelos[0].origin.airport_position[0]);
        for (var i = 0; i < vuelos.length; i++){
          var vuelo = vuelos[i];
          var origin = vuelo.origin;
          var destination = vuelo.destination;
          var line_data = [
            {lat: destination.airport_position[0], lng: destination.airport_position[1]},
            {lat: origin.airport_position[0], lng: origin.airport_position[1]}
          ];
          var flightPath = new google.maps.Polyline({
            path: line_data,
            geodesic: true,
            strokeColor: '#000000',
            strokeOpacity: 1.0,
            strokeWeight: 2
          });

          flightPath.setMap(map);

        };
      });



      // Initialize and add the map
      // Add Marker function

      /*var markers = [
        {
          coords:location,
          iconImage:'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
          content:'<h1>HELLOW WORLD</h1>\n<h2>Tarolas</h2>'
        }
      ];

      // Loop through markers
      for (var i = 0; i < markers.length; i++){
        addMarker(markers[i], map);
      }*/

      // Recibo la informacion del socket al hacer socket.on POSITION
      socket.on('POSITION', function(data){
        console.log('Avion: '+ data.code +' Posicion: ' + data.position);
        marker_data = {

          coords: {lat:data.position[0], lng: data.position[1]},
          iconImage:'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
          content:'<h1>'+ data.code +'</h1>'
        };
        addMarker(marker_data, map);
      });

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBW9yZgKJUsNAQChayGv6s1K1S7Lf2-Erc&callback=initMap">
    </script>
  </body>
</html>
